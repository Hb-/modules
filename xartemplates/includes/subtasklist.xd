<xar:set name="xtasks_objectid">xarModGetVar('xtasks','xtasks_objectid')</xar:set>
<xar:data-getitem name="$properties" module="xTasks" itemtype="1" itemid="$xtasks_objectid" />
    
<xar:set name="dummy">xarVarFetch('module', 'str::', $module, "", XARVAR_NOT_REQUIRED)</xar:set>

<xar:set name="statusbgcolor">array()</xar:set>
<xar:set name="dummy">$statusbgcolor['Draft'] = "#CCCCCC"</xar:set>
<xar:set name="dummy">$statusbgcolor['Active'] = "#00FF66"</xar:set>
<xar:set name="dummy">$statusbgcolor['Closed'] = "#999999"</xar:set>
<xar:set name="dummy">$statusbgcolor['Pending Approval'] = "#FF9999"</xar:set>

<xar:set name="ttlcolumns">4</xar:set>
        
<xar:if condition="!isset($m)"><xar:set name="m">16</xar:set></xar:if>
<xar:set name="m">(int)($m - 1)</xar:set>
<xar:set name="m_hex">dechex($m)</xar:set>
<xar:set name="bg_color">"#".$m_hex.$m_hex.$m_hex.$m_hex.$m_hex.$m_hex</xar:set>
<xar:set name="textpct">(int)( ($m / 16) * 100 )</xar:set>

<xar:set name="indent">$depth * 15</xar:set>

<xar:set name="ttlhours">xarVarGetCached('xtasks.workspace', 'ttlhours')</xar:set>

<xar:foreach in="$subtasklist" value="$taskinfo">
    <xar:if condition="$module ne 'xtasks'">
        <xar:if condition="$taskinfo['status'] ne 'Active' and $taskinfo['status'] ne 'Closed' and $taskinfo['status'] ne 'Draft'">
            <xar:set name="bg_color">$statusbgcolor['Pending Approval']</xar:set>
        <xar:else />
            <xar:set name="bg_color">$statusbgcolor[$taskinfo['status']]</xar:set>
        </xar:if>
    </xar:if>
    <tr style="height: 20px; background-color: #$bg_color#;">
        <td class="xtasks-tasklist-data" style="background-color: #$bg_color#; width: 50px; white-space: nowrap;">
            <xar:set name="taskcheckname">"taskcheck[".$taskinfo['taskid']."]"</xar:set>
            <xar:data-input type="checkbox" name="$taskcheckname" /><input type="submit" name="taskfocus[#$taskinfo.taskid#]" value="+" style="color: black; display: inline;">
        </td>
        
        <td class="xtasks-tasklist-data" style="background-color: #$bg_color#; font-size: #$textpct#%; width: auto; text-align: left; padding-left: #$indent#px;">
            <img src="modules/xtasks/xarimages/subtask-arrow.png" align="top"><!-- &#8658; or &#8594; -->
            <a href="&xar-modurl-xtasks-admin-display;&amp;taskid=#$taskinfo['taskid']#">#$taskinfo['task_name']#</a>
        </td>
            
        <xar:if condition="!empty($show_owner)">
            <xar:set name="ttlcolumns">$ttlcolumns+1</xar:set>
            <td class="xtasks-tasklist-data" style="text-align: center; width: 100px; background-color: #$bg_color#; font-size: #$textpct#%;"><xar:data-output property="$properties['owner']" value="$taskinfo['owner']" /></td>
        </xar:if>
    
        <xar:if condition="$show_age">
            <xar:set name="ttlcolumns">$ttlcolumns+1</xar:set>
            <td class="xtasks-tasklist-data" style="text-align: center; width: 40px; background-color: #$bg_color#; font-size: #$textpct#%;">#$taskinfo['days_old']#</td>
        </xar:if>
    
        <xar:if condition="$show_hours">
            <xar:set name="ttlhours">$ttlhours+$taskinfo['hours_remaining']</xar:set>
            <xar:set name="ttlcolumns">$ttlcolumns+1</xar:set>
            <td class="xtasks-tasklist-data" style="text-align: center; width: 40px; background-color: #$bg_color#; font-size: #$textpct#%;">#$taskinfo['hours_remaining']#</td>
        </xar:if>
                
        <xar:if condition="$show_pctcomplete">
            <xar:set name="ttlcolumns">$ttlcolumns+1</xar:set>
            <xar:set name="pctcomplete">0</xar:set>
            <xar:set name="ttlhours">$taskinfo['hours_spent'] + $taskinfo['hours_remaining']</xar:set>
            <xar:if condition="$ttlhours gt 0">
                <xar:set name="pctcomplete">$taskinfo['hours_spent'] / ($taskinfo['hours_spent'] + $taskinfo['hours_remaining'])</xar:set>
            </xar:if>
            <xar:set name="pctcomplete">sprintf("%0.0f", 100 * $pctcomplete)."%"</xar:set>
            <td class="xtasks-tasklist-data" style="text-align: right; width: 40px; background-color: #$bg_color#; font-size: #$textpct#%;">#$pctcomplete#</td>
        </xar:if>
        
        <xar:if condition="$show_importance and $orderby ne 'importance'">
            <xar:set name="ttlcolumns">$ttlcolumns+1</xar:set>
            <xar:set name="importance">$taskinfo['importance']</xar:set>
            <td class="xtasks-tasklist-data" style="text-align: center; center; width: 80px; background-color: #$bg_color#; font-size: #$textpct#%;">
                <div style="float: left; width: 65px;">
                    <xar:data-output property="$properties['importance']" value="$importance" />
                </div>
                <div style="width: 10px; height: 16px; float: right; margin-top: 2px;">
                    <div style="height: 10px; vertical-align: top;">
                        <xar:if condition="$taskinfo.importance gt 1">
                            <a href="&xar-modurl-xtasks-admin-chngimportance;&amp;taskid=#$taskinfo.taskid#&amp;mode=decr&amp;authid=#$authid#&amp;returnurl=#$encoded_returnurl#"><img src="modules/xtasks/xarimages/up.gif" align="top"></a>
                        </xar:if>
                    </div>
                    <div style="height: 8px; vertical-align: top;">
                        <xar:if condition="$taskinfo.importance lt 9">
                            <a href="&xar-modurl-xtasks-admin-chngimportance;&amp;taskid=#$taskinfo.taskid#&amp;mode=incr&amp;authid=#$authid#&amp;returnurl=#$encoded_returnurl#"><img src="modules/xtasks/xarimages/down.gif" align="top"></a>
                        </xar:if>
                    </div>
                </div>
                <div style="clear; both;"></div>
            </td>
        </xar:if>
    
        <xar:if condition="$show_priority and $orderby ne 'priority'">
            <xar:set name="ttlcolumns">$ttlcolumns+1</xar:set>
            <td class="xtasks-tasklist-data" style="text-align: center; center; width: 80px; background-color: #$bg_color#; font-size: #$textpct#%;">
                <div style="float: left; width: 65px;">#$taskinfo['priority']#</div>
                <div style="width: 10px; height: 16px; float: right; margin-top: 2px;">
                    <div style="height: 10px; vertical-align: top;">
                        <xar:if condition="$taskinfo.priority gt 1">
                            <a href="&xar-modurl-xtasks-admin-reprioritize;&amp;taskid=#$taskinfo.taskid#&amp;mode=decr&amp;authid=#$authid#&amp;returnurl=#$encoded_returnurl#"><img src="modules/xtasks/xarimages/up.gif" align="top"></a>
                        </xar:if>
                    </div>
                    <div style="height: 8px; vertical-align: top;">
                        <xar:if condition="$taskinfo.priority lt 9">
                            <a href="&xar-modurl-xtasks-admin-reprioritize;&amp;taskid=#$taskinfo.taskid#&amp;mode=incr&amp;authid=#$authid#&amp;returnurl=#$encoded_returnurl#"><img src="modules/xtasks/xarimages/down.gif" align="top"></a>
                        </xar:if>
                    </div>
                </div>
                <div style="clear; both;"></div>
            </td>
        </xar:if>
    
        <xar:if condition="$orderby ne 'status'">
            <td class="xtasks-tasklist-data" style="text-align: center; width: 80px; background-color: #$bg_color#; font-size: #$textpct#%;">#$taskinfo['status']#</td>
        </xar:if>
        
        <td class="xtasks-tasklist-data" style="text-align: center; vertical-align: bottom; width: 50px; background-color: #$bg_color#; font-size: #$textpct#%; white-space: pre;"><a href="javascript: void twist('worklist#$taskinfo['taskid']#');" title="View Task Update"><img src="modules/xtasks/xarimages/rotate.gif" border="0" /></a><a href="&xar-modurl-xtasks-worklog-new;&amp;taskid=#$taskinfo['taskid']#&amp;inline=1&amp;returnurl=#$encoded_returnurl#" onClick="twist_open('worklist#$taskinfo['taskid']#'); return loadContent(this.href,'newtask');" title="Document Work Performed"><img src="modules/xtasks/xarimages/button.work.gif" border="0" /></a><a href="&xar-modurl-xtasks-admin-reassign;&amp;taskid=#$taskinfo['taskid']#&amp;returnurl=#$encoded_returnurl#"><img src="modules/xtasks/xarimages/button.reassign.gif" border="0"></a><a href="&xar-modurl-xtasks-admin-modify;&amp;taskid=#$taskinfo['taskid']#"><img src="modules/xtasks/xarimages/button.edit.gif" border="0" align="bottom"></a><a href="&xar-modurl-xtasks-admin-delete;&amp;taskid=#$taskinfo['taskid']#"><img src="modules/xtasks/xarimages/button.delete.gif" border="0" align="bottom"></a></td>
    
    </tr>

    <xar:set name="date_start_planned">$taskinfo['date_start_planned']</xar:set>
    <xar:set name="date_start_actual">$taskinfo['date_start_actual']</xar:set>
    <xar:set name="date_end_planned">$taskinfo['date_end_planned']</xar:set>
    <xar:set name="date_end_actual">$taskinfo['date_end_actual']</xar:set>
        
    <xar:if condition="isset($verbose)">
        <tr>
            <td class="xtasks-tasklist-data" colspan="#$ttlcolumns#" style="padding-left: 25px;"><div style="max-height: 200px; overflow: auto;">#$taskinfo['formatted_desc']#
                <xar:if condition="$show_planned_dates">
                    <xar:if condition="!empty($planned_start_date) or !empty($planned_end_date)">
                        <br><xar:mlstring>Planned Timeframe:</xar:mlstring>
                        <xar:if condition="!empty($planned_start_date)">
                            <xar:mlstring> from </xar:mlstring><em><xar:data-output property="$properties['planned_start_date']" value="$planned_start_date" dateformat="%a, %d %B %Y" /></em>
                        </xar:if>
                        <xar:if condition="!empty($planned_end_date)">
                            <xar:mlstring> thru </xar:mlstring><em><xar:data-output property="$properties['planned_end_date']" value="$planned_end_date" dateformat="%a, %d %B %Y" /></em>
                        </xar:if>
                    </xar:if>
                </xar:if>

                <xar:if condition="$show_actual_dates">
                    <xar:if condition="!empty($actual_start_date) or !empty($actual_end_date)">
                        <br><xar:mlstring>Actual Timeframe:</xar:mlstring>
                        <xar:if condition="!empty($actual_start_date)">
                            <xar:mlstring> from </xar:mlstring><em><xar:data-output property="$properties['actual_start_date']" value="$actual_start_date" dateformat="%a, %d %B %Y" /></em>
                        </xar:if>
                        <xar:if condition="!empty($planned_end_date)">
                            <xar:mlstring> thru </xar:mlstring><em><xar:data-output property="$properties['actual_end_date']" value="$actual_end_date" dateformat="%a, %d %B %Y" /></em>
                        </xar:if>
                    </xar:if>
                </xar:if>
            </div></td>
        </tr>
    </xar:if>
    
    <xar:set name="worklog">xarModAPIFunc('xtasks','worklog','getallfromtask',array('taskid'=>$taskinfo['taskid']))</xar:set>
    <!--<xar:if condition="count($worklog) gt 0">-->
        <tr><td colspan="#$ttlcolumns#" class="xproject-list-data" style="padding-left: 55px;"><div id="worklist#$taskinfo['taskid']#" style="display: none;"><xar:template type="module" file="worklog" subdata="array('worklog'=&gt;$worklog)" /></div></td></tr>
    <!--</xar:if>-->
            
    <xar:if condition="$taskinfo['numchildren'] gt 0">
        <tr>
            <td colspan="#$ttlcolumns#" style="margin: 0px; padding: 0px;">
                <xar:set name="deeper">$depth + 1</xar:set>
                <xar:if condition="$depth lt 7">
                    <xar:set name="subtasklist">xarModAPIFunc('xtasks', 'user', 'getall', array('parentid' => $taskinfo['taskid'], 'orderby' => $orderby))</xar:set>
                    <xar:if condition="is_array($subtasklist)">
                        <xar:template type="module" file="subtasklist" subdata="array('m'=&gt;$m,
                                                                                    'depth'=&gt;$deeper,
                                                                                    'authid'=&gt;$authid,
                                                                                    'orderby'=&gt;$orderby,
                                                                                    'startnum'=&gt;$startnum,
                                                                                    'show_age'=&gt;$show_age,
                                                                                    'show_owner'=&gt;$show_owner,
                                                                                    'show_pctcomplete'=&gt;$show_pctcomplete,
                                                                                    'show_hours'=&gt;$show_hours,
                                                                                    'show_importance'=&gt;$show_importance,
                                                                                    'show_priority'=&gt;$show_priority,
                                                                                    'show_planned_dates'=&gt;$show_planned_dates,
                                                                                    'show_actual_dates'=&gt;$show_actual_dates,
                                                                                    'verbose'=&gt;$verbose,
                                                                                    'subtasklist'=&gt;$subtasklist,
                                                                                    'encoded_returnurl'=&gt;$encoded_returnurl)" />
                    </xar:if>
                </xar:if>
            </td>
        </tr>        
    </xar:if>
</xar:foreach>
