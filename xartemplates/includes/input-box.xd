<xar:template xmlns:xar="http://xaraya.com/2004/blocklayout">
    <xar:set name="is_sendtouser">
        xarModAPIFunc('messages','user','is_sendtouser', 
            array(
                'sendtouser' => $recipient,
            )
        )
    </xar:set>
    
    <h3>#$input_title#</h3>
    <form id="inputbox" action="#$post_url#" method="post" enctype="multipart/form-data">
        <div class="xar-form-input-wrapper">
            <label class="xar-form-label">
                <xar:mlstring>From:</xar:mlstring>
            </label>
            #xarUserGetVar('name')#
            <!--Psspl:Modified the code for anonymous message-->
            <xar:if condition="isset($action) and $action ne 'reply' and $action ne 'prev_reply' AND $is_sendtouser">
                <xar:if condition="isset($id) and isset($postanon)">
                    <xar:data-input type="checkbox"  name="postanon" checked="$postanon" />
                <xar:else />
                    <xar:if condition="isset($postanon)">
                        <xar:data-input type="checkbox"  name="postanon" checked="$postanon" />
                    <xar:else/>
                        <xar:data-input type="checkbox"  name="postanon" checked="1" />
                    </xar:if>        
                </xar:if>
                <xar:mlstring>
                    Post anonymously
                </xar:mlstring>
            </xar:if>
        </div>

        <div class="xar-form-input-wrapper">
            <label for="recipient" title="#xarML('To whom the message will be sent')#" class="xar-form-label">
                <xar:mlstring>To:</xar:mlstring>
            </label>
            <xar:if condition="isset($action) and $action ne 'reply' and $action ne 'prev_reply' and $action ne 'modify'">
                <xar:if condition="empty($users)">
                    No recipients available
                <xar:else />
                    <xar:data-inpt type="dropdown" name="recipient" value="$recipient" options="$users" />
                </xar:if>
            </xar:if>
            <xar:if condition="isset($action) and $action eq 'reply' or $action eq 'prev_reply' ">
                <xar:if condition="$postanon eq 0 AND $is_sendtouser">
                    <xar:mlstring>#$recipient_name#</xar:mlstring>      
                <xar:else/>
                    <xar:mlstring>Anonymous</xar:mlstring>
                </xar:if>
                <input type="hidden" value="#$recipient#" name="recipient" id="recipient" />
            <xar:elseif condition="isset($action) and $action eq 'modify' /">
                <xar:if condition="$is_sendtouser">
                    <xar:data-inpt type="dropdown" name="recipient" value="$recipient" options="$users" />
                <xar:else/>
                    <xar:mlstring>Anonymous</xar:mlstring>
                </xar:if>   
                <input type="hidden" value="#$recipient#" name="recipient" id="recipient" />
            </xar:if>
            <xar:if condition="isset($no_recipient)">
                <span class="xar-error">
                    <xar:mlstring>Missing!</xar:mlstring>
                </span>
            </xar:if>
        </div>

        <div class="xar-form-input-wrapper">
            <label for="subject" title="#xarML('Message subject')#" class="xar-form-label">
                <xar:mlstring>Subject:</xar:mlstring>
            </label>
            <xar:if condition="!empty($subject)">
                <input type="text" name="subject" id="subject" class="xar-form-textxlong" maxlength="85" value="#xarVarPrepForDisplay($subject)#" tabindex="1" />
            <xar:else />
                <input type="text" name="subject" id="subject" class="xar-form-textxlong" maxlength="85" value="" tabindex="1" />
            </xar:if>
            <xar:if condition="isset($no_subject)">
                <span class="xar-error">
                    <xar:mlstring>Missing!</xar:mlstring>
                </span>
            </xar:if>
        </div>

        <div class="xar-form-input-wrapper">
            <label for="body" title="#xarML('Message text')#" class="xar-form-label">
                <xar:mlstring>Message:</xar:mlstring>
            </label>
            <xar:if condition="isset($no_body)">
                <span class="xar-error">
                    <xar:mlstring>Missing!</xar:mlstring>
                </span>
            </xar:if>
            <xar:if condition="isset($body)">
                <textarea cols="" rows="" name="body" id="body" class="xar-form-textarealarge" tabindex="2">#xarVarPrepForDisplay($body)#</textarea>
            <xar:else />
                <textarea cols="" rows="" name="body" id="body" class="xar-form-textarealarge" tabindex="2">&#160;</textarea>
            </xar:if>
        </div>

        <xar:if condition="xarModVars::get('messages','drafts') eq 1">
            <div class="xar-form-input-wrapper-after">
                <xar:if condition="isset($draft) and $draft eq true">
                    <input type="checkbox" name="draft" id="draft" value="1" checked="checked" />
                <xar:else />
                    <input type="checkbox" name="draft" id="draft" value="1" />
                </xar:if>
                <label for="draft" title="#xarML('Save this message to be sent later')#">
                    <xar:mlstring>Save as draft</xar:mlstring>
                </label>
            </div>
        </xar:if>

        <div class="xar-align-center xar-margin-thick">
            <input type="hidden" name="authid" id="authid" value="#xarSecGenAuthKey()#" />
            <xar:if condition="isset($mid)">
                <input type="hidden" name="mid" id="mid" value="#$mid#" />
            </xar:if>
            <xar:if condition="isset($id)">
                <input type="hidden" name="id" id="id" value="#$id#" />
            </xar:if>
            <xar:if condition="isset($action)"> 
                <xar:if condition="$action eq 'reply'">
                    <input type="hidden" name="action" id="action" value="prev_reply" />
                    <input type="hidden" name="postanon_to" id="postanon_to" value="#$postanon_to#" />
                </xar:if>
                <xar:if condition="$action eq 'modify'">
                    <input type="hidden" name="action" id="action" value="prev_reply" />
                    <input type="hidden" name="postanon_to" id="postanon_to" value="#$postanon_to#" />
                </xar:if>
                <xar:if condition="$action eq 'prev_reply'">
                    <input type="hidden" name="action" id="action" value="prev_reply" />
                    <input type="hidden" name="postanon_to" id="postanon_to" value="#$postanon_to#" />
                </xar:if>
             </xar:if>
            <input type="submit" name="preview" id="preview" value="#xarML('Preview')#" class="xar-margin-thickright" />
            <input type="submit" name="confirm" id="confirm" value="#xarML('Submit')#" class="xar-margin-thickleft" />
        </div>
    </form>
</xar:template>