<div class="ievents-search">
<div class="ievents-search-inner">
    <h1><xar:mlstring>Search Events</xar:mlstring></h1>

    <xar:if condition="xarThemeIsAvailable('rss') or !empty($export_handlers)">
        <p>
            <xar:if condition="xarThemeIsAvailable('rss')">
                <a href="#xarModURL('ievents','user','view',array_merge($feed_params,array('format'=&gt;'rss')))#" class="ievents-export-rss" title="#xarML('RSS feed for these events')#">RSS</a>
            </xar:if>

            <xar:if condition="!empty($export_handlers)">
                <xar:loop name="$export_handlers">
                    <xar:if condition="$loop:index gt 0 or xarThemeIsAvailable('rss')"> | </xar:if>
                    <a href="#xarModURL('ievents','user','view',array_merge($feed_params,array('format'=&gt;$loop:key)))#" title="#$loop:item.desc#" class="ievents-export-#$loop:item.class#">#$loop:item.short#</a>
                </xar:loop>
            </xar:if>
        </p>
    </xar:if>

    <form method="get" action="#xarModURL('ievents','user','view')#">
    
    <div class="ievents-search-simple">
        <table>
            <tr>
                <xar:if condition="!empty($q_fields)">
                    <td id="ievents-td-q">
                        <label for="q" id="q_label"><xar:mlstring>Search:</xar:mlstring></label>
                        <input type="text" name="q" id="q" value="#xarVarPrepForDisplay($q)#" />
                    </td>
                </xar:if>
                <td>
                    <label for="daterangelist" id="daterange_label"><xar:mlstring>Date Range:</xar:mlstring></label>
                    <xar:set name="daterangelist">#xarModAPIfunc('ievents','user','params',array('name'=&gt;'daterangelist'))#</xar:set>
                    <xar:data-input name="range" id="daterange" type="6" validation="$daterangelist" value="" />
                </td>
                <td>
                    <label for="cid" id="calendar_label"><xar:mlstring>Calendar:</xar:mlstring></label>
                    <xar:set name="calendarlist">#xarModAPIfunc('ievents','user','list_calendars',array('readable'=&gt;true,'mandatory'=&gt;false))#</xar:set>
                    <xar:if condition="!empty($calendarlist) and count($calendarlist) gt 1">
                        <xar:data-input name="cid" id="calendar" type="6" validation="$calendarlist" value="$cid" />
                    </xar:if>
                </td>
                <td><input type="submit" value="#xarML('Find Events')#" /></td>
            </tr> 
        </table>

        <xar:comment>
            Use javascript to enable and disable the advanced search options as it is clicked.
            This checkbox ensures it is tracked from page to page.
        </xar:comment>
        <xar:if condition="empty($advanced)">
            <input type="checkbox" name="advanced" id="advanced" value="y" />
        <xar:else />
            <input type="checkbox" name="advanced" id="advanced" value="y" checked="checked" />
        </xar:if>
        <label for="advanced"><xar:mlstring>Advanced search options</xar:mlstring></label>
    </div>

    <xar:comment>Begin Advanced Search Section</xar:comment>
    <xar:if condition="!empty($advanced)">
        <xar:set name="adv_form_class">'ievents-search-advanced'</xar:set>
    <xar:else />
        <xar:set name="adv_form_class">'ievents-search-advanced ievents-search-advanced-hidden'</xar:set>
    </xar:if>

    <div class="#$adv_form_class#">
        <div class="ievents-search-box-first">
            <table>
                <tr>
                    <td class="daterange-cell">
                        <xar:comment>If showing a calendar view, then make this a single-ended date</xar:comment>
                        <xar:if condition="$format eq 'cal'">
                            <label for="startday"><xar:mlstring>Jump to date:</xar:mlstring></label>
                        <xar:else />
                            <label for="startday"><xar:mlstring>Search over a date range:</xar:mlstring></label>
                        </xar:if>
                        <div class="ievents-date-parts-all">
                            <span class="ievents-date-parts">
                                <xar:data-input name="startday" id="startday" type="6" validation="$lists['daynum']" value="$startday" />
                                <xar:data-input name="startmonth" id="startmonth" type="6" validation="$lists['monthshort']" value="$startmonth" />
                                <xar:data-input name="startyear" id="startyear" type="6" validation="$lists['yearnum']" value="$startyear" />
                            </span>
                            <xar:if condition="$format ne 'cal'">
                                <span class="ievents-date-divider"><xar:mlstring> to </xar:mlstring></span>
                                <span class="ievents-date-parts">
                                    <xar:data-input name="endday" id="endday" type="6" validation="$lists['daynum']" value="$endday" />
                                    <xar:data-input name="endmonth" id="endmonth" type="6" validation="$lists['monthlong']" value="$endmonth" />
                                    <xar:data-input name="endyear" id="endyear" type="6" validation="$lists['yearnum']" value="$endyear" />
                                </span>
                            </xar:if>
                        </div>
                    </td>
                    <td class="groupby-cell">
                        <label for="group">Group by:</label>
                        <xar:set name="grouplist">#xarModAPIfunc('ievents','user','params',array('name'=&gt;'grouplist'))#</xar:set>
                        <xar:data-input name="group" id="group" type="6" validation="$grouplist" value="$group" />
                    </td>
                </tr>
            </table>
        </div>

        <xar:comment>TODO: only include these three hidden values if short URLs are not being used</xar:comment>
        <input type="hidden" name="module" value="ievents" />
        <input type="hidden" name="type" value="user" />
        <input type="hidden" name="func" value="view" />

        <xar:comment>Reset a few values if the jump menu is used</xar:comment>
        <xar:if condition="!empty($startnum)">
            <input type="hidden" name="startnum" value="1" />
        </xar:if>
        <xar:if condition="!empty($numitems) && $numitems ne $default_numitems">
            <input type="hidden" name="numitems" value="#$numitems#" />
        </xar:if>
        <xar:if condition="!empty($format)">
            <input type="hidden" name="format" value="#$format#" />
        </xar:if>

        <xar:comment>The categories are optional</xar:comment>
        <xar:if condition="!empty($categories.basecats)">
        <div class="ievents-search-box">
            <p>
                <label for="catids_0" id="catids_0_label"><xar:mlstring>Categories:</xar:mlstring></label>
                <xar:loop name="$categories['basecats']" id="basecats">
                    <xar:if condition="!empty($loop:item.catlist)">
                        <select class="ievents-jump-catids" name="catids[]" id="catids_#$loop:index#" multiple="multiple">
                            <optgroup label="#xarVarPrepForDisplay($loop:basecats:item.catname)#">
                            <xar:set name="max_cat_depth">#xarModAPIfunc('ievents','user','params',array('name'=&gt;'max_cat_depth'))#</xar:set>
                            <xar:loop name="$loop:item.catlist">
                                <xar:if condition="$loop:item.level le $max_cat_depth">
                                    <xar:if condition="in_array($loop:item.cid, $catids)">
                                        <option value="#$loop:item.cid#" selected="selected">
                                            #xarVarPrepForDisplay(str_repeat('---', $loop:item.level-1))##xarVarPrepForDisplay($loop:item.name)#
                                        </option>
                                    <xar:else />
                                        <option value="#$loop:item.cid#">
                                            #xarVarPrepForDisplay(str_repeat('---', $loop:item.level-1))##xarVarPrepForDisplay($loop:item.name)#
                                        </option>
                                    </xar:if>
                                </xar:if>
                            </xar:loop>
                            </optgroup>
                        </select>
                    </xar:if>
                </xar:loop>
            </p> 

            <p>
                <span id="crule_1_wrapper">
                    <xar:if condition="$crule eq 'or'">
                        <input type="radio" name="crule" id="crule_1" value="or" checked="checked" />
                    <xar:else />
                        <input type="radio" name="crule" id="crule_1" value="or" />
                    </xar:if>
                    <label for="crule_1" id="crule_1_label"><xar:mlstring>Match <em>any</em> selected category</xar:mlstring></label>
                </span>

                <span id="crule_2_wrapper">
                    <xar:if condition="$crule eq 'and'">
                        <input type="radio" name="crule" id="crule_2" value="and" checked="checked" />
                    <xar:else />
                        <input type="radio" name="crule" id="crule_2" value="and" />
                    </xar:if>
                    <label for="crule_2" id="crule_2_label"><xar:mlstring>Match <em>all</em> selected categories</xar:mlstring></label>
                </span>
            </p>
        </div>
        </xar:if>

        <div class="ievents-search-box-bottom">
            <p class="adv-submit">
                <input type="submit" value="#xarML('Find Events')#" />
            </p>
        </div>
        <xar:comment>End Advanced Search section</xar:comment>
    </div>
    </form>
</div>
</div>
