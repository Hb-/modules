<xar:comment>
    Display an event detail as a 'dl' list entry.
    Requires the following paramaters:
    - $event
    - $calendar (current calendar record)
    - $categories (full list of available categories)
</xar:comment>

<xar:set name="dates">#xarModAPIfunc('ievents','user','format_datetime',array('event'=&gt;$event))#</xar:set>

<dt class="ievents-event" style="border: none;">
    <h2><a href="#xarModURL('ievents','user','view',array('eid'=&gt;$event.eid))#">#xarVarPrepForDisplay($event.title)#</a></h2>
    <xar:if condition="xarSecurityCheck('ModerateIEvent', 0, 'IEvent', $event['calendar_id'] . ':' .$event['eid']. ':' . $event['created_by'])">
        [<a href="#xarModURL('ievents','user','modify',array('eid'=&gt;$event.eid,'return_url'=&gt;xarServerGetCurrentURL(array(),false)))#"><xar:mlstring>edit</xar:mlstring></a>]
    </xar:if>
    <xar:if condition="xarSecurityCheck('DeleteIEvent', 0, 'IEvent', $event['calendar_id'] . ':' .$event['eid']. ':' . $event['created_by'])">
        [<a href="#xarModURL('ievents','user','delete',array('eid'=&gt;$event.eid,'return_url'=&gt;xarServerGetCurrentURL(array('eid'=&gt;NULL),false)))#"><xar:mlstring>delete</xar:mlstring></a>]
    </xar:if>
</dt>

<xar:if condition="!empty($calendar.event_header)">
    <dd class="ievents-event-calheader">#$calendar.event_header#</dd>
</xar:if>

<dt>
    <xar:mlstring>Summary</xar:mlstring>
</dt>

<dd class="ievents-event-summary">
    <xar:template file="event-flags" subdata="array('event'=&gt;$event)" />
    <p>
        <strong><xar:mlstring>Date:</xar:mlstring></strong> #$dates.long.date#
        <xar:if condition="$event.duration_days eq 1">
            #$dates.short.time#
        </xar:if>

        <strong style="margin-left: 2em;"><xar:mlstring>Calendar:</xar:mlstring></strong>
        <a href="#xarModURL('ievents','user','viewcals',array('cid'=&gt;$calendar.cid))#">
            #xarVarPrepForDisplay($calendar.long_name)#
        </a>
    </p>
    <xar:if condition="!empty($event.cost)">
        <p><strong><xar:mlstring>Cost:</xar:mlstring></strong> #xarVarPrepForDisplay($event.cost)#</p>
    </xar:if>
    <xar:if condition="!empty($event.summary)">
        <p>#xarVarPrepForDisplay(xarModAPIfunc('ievents','user','transform', array('text'=&gt;$event.summary)))#</p>
    </xar:if>
</dd>

<xar:if condition="!empty($event.catids)">
    <dd class="ievents-event-categories">
        <xar:mlstring>Categories:</xar:mlstring>
        <xar:loop name="$event.catids">
            <xar:if condition="$loop:index gt 0"> | </xar:if>
            <a href="#xarServerGetCurrentURL(array('cats'=&gt;$loop:item,'eid'=&gt;NULL))#">
                #xarVarPrepForDisplay($categories['flatlist'][$loop:item]['name'])#
            </a>
        </xar:loop>
    </dd>
</xar:if>

<xar:comment>
    Amount to be displayed depends on the user permissions.
    Only display the detail if the user has read privilege. The summary requires only overview privilege.
</xar:comment>

<xar:sec mask="ReadIEvent" instance="$event[calendar_id]:$event[eid]:ALL" catch="false">
    <xar:if condition="!empty($event.description)">
        <dt><xar:mlstring>Detail</xar:mlstring></dt>
        <dd>#$event.description#</dd>
    </xar:if>
    <dd class="ievent-url">
        <xar:if condition="!empty($event.url) && $event.url ne 'http://'">
            <p>
                <xar:ml>
                    <xar:mlstring><a href="#(1)">More information and to book a place</a> (<a href="#(1)" target="_blank">New window</a>)</xar:mlstring>
                    <xar:mlvar>#xarVarPrepForDisplay($event.url)#</xar:mlvar>
                </xar:ml>
            </p>
        </xar:if>
    </dd>

    <xar:comment>
        TODO: do something with flags, last updated ('updated' flag if recent?), status (if admin - treat as a flag?),
        links to categories, created date ('new' flag if recent)
    </xar:comment>

    <xar:if condition="!empty($event.location)">
        <dt><xar:mlstring>Location</xar:mlstring></dt>
        <dd class="ievent-location">
            <xar:if condition="!empty($event.location.venue)">
                <p><strong><xar:mlstring>Venue:</xar:mlstring></strong> #xarVarPrepForDisplay($event.location.venue)#</p>
            </xar:if>

            <xar:if condition="!empty($event.address_formatted)">
                <p><strong><xar:mlstring>Address:</xar:mlstring></strong></p>
                #xarModAPIfunc('ievents','user','transform', array('html'=&gt;$event.address_formatted))#
            </xar:if>

            <xar:comment>
                <xar:if condition="!empty($event.location.address)">
                    <p><strong><xar:mlstring>Address:</xar:mlstring></strong></p>
                    #xarModAPIfunc('ievents','user','transform', array('html'=&gt;$event.location.address))#
                </xar:if>
                <xar:if condition="!empty($event.location.country)">
                    <p><strong><xar:mlstring>Country:</xar:mlstring></strong> #xarVarPrepForDisplay($event.location.country)#</p>
                </xar:if>
                <xar:if condition="!empty($event.location.postcode)">
                    <p><strong><xar:mlstring>Postcode:</xar:mlstring></strong> #xarVarPrepForDisplay($event.location.postcode)#</p>
                </xar:if>
            </xar:comment>

            <xar:comment>
                Use the postcode to nip off to maps and directions etc. Could do this by hooks, but we'll call up
                a sub-template to do it.
            </xar:comment>
            <xar:template file="event-directions-dl" />
        </dd>
    </xar:if>

    <xar:if condition="!empty($event.contact)">
        <dt><xar:mlstring>Contact</xar:mlstring></dt>
        <dd class="ievent-contact">
            <xar:if condition="!empty($event.contact.email)">
                <p><strong><xar:mlstring>E-mail:</xar:mlstring></strong> <a href="mailto:#xarVarPrepForDisplay($event.contact.email)#">#xarVarPrepForDisplay($event.contact.email)#</a></p>
            </xar:if>
            <xar:if condition="!empty($event.contact.phone)">
                <p><strong><xar:mlstring>Phone:</xar:mlstring></strong> #xarVarPrepForDisplay($event.contact.phone)#</p>
            </xar:if>
            <xar:if condition="!empty($event.contact.details)">
                <p><strong><xar:mlstring>Further details:</xar:mlstring></strong></p>
                #$event.contact.details#
            </xar:if>
        </dd>
    </xar:if>
</xar:sec>

<xar:if condition="!empty($export_handlers)">
    <dt><xar:mlstring>Download this event</xar:mlstring></dt>
    <dd class="ievent-export-links">
        <p>
            <xar:loop name="$export_handlers">
                <xar:if condition="$loop:index gt 0"> | </xar:if>
                <a href="#xarModURL('ievents','user','view',array('export'=&gt;$loop:key,'eid'=&gt;$event.eid))#" title="#$loop:item.long#" class="ievents-export-#$loop:item.class#">#$loop:item.short#</a>
            </xar:loop>
        </p>
    </dd>
</xar:if>

<xar:if condition="!empty($calendar.event_header)">
    <dd class="ievents-event-calfooter">#$calendar.event_footer#</dd>
</xar:if>
