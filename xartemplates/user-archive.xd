
<xar:style file="mag" scope="module" module="mag" />
<xar:style file="mag-custom" scope="module" module="mag" />

<xar:template file="custom-navbar" module="mag" />

<div class="mag mag-archive">

    <xar:if condition="empty($mag)">
        <xar:template file="error-no-mag" module="mag" />
    <xar:else />
        <h1>
            <a href="#xarModAPIfunc('mag','user','url',array('func'=&gt;'mags','mag'=&gt;$mag.ref))#">#xarVarPrepForDisplay($mag.title)#</a>
        </h1>
        <p class="mag-synopsis">#$mag.subtitle#</p>

        <xar:set name="mag_ref">#$mag.ref#</xar:set>

        <xar:comment>TODO: call up a hook template here so text can be inserted by the theme</xar:comment>

        <xar:comment>Loop for each year to start with</xar:comment>

        <xar:if condition="empty($issues)">
            <xar:template file="error-no-issue" module="mag" />
        <xar:else />
            <div>
                <xar:loop name="$years" id="years">
                    <xar:comment>
                        Display the title for the year.
                        Include the month if there happens to be just one month in total.
                    </xar:comment>

                    <h2 class="mag-grouping">
                        <xar:ml>
                            <xar:mlstring>Archive year: #(1)</xar:mlstring>
                            <xar:mlvar>#$loop:years:key#</xar:mlvar>
                        </xar:ml>
                    </h2>

                    <xar:loop name="$loop:years:item" id="months">
                        <xar:comment>Display the titles for each month group</xar:comment>
                        <xar:if condition="$max_month_count gt 1">
                            <h3 class="mag-grouping">
                                <xar:ml>
                                    <xar:mlstring>#(1)</xar:mlstring>
                                    <xar:mlvar>#$month_names[$loop:months:key]#</xar:mlvar>
                                </xar:ml>
                            </h3>
                        </xar:if>

                        <xar:comment>
                            Display the issues.
                            Use a sub-template to do this, so that each magazine type can have its own
                            version (some may use front page images, some just text etc.
                            The sub-template is 'archive-issues-{mag-ref}' falling back to 'archive-issues'.
                        </xar:comment>

                        <xar:if condition="!empty($style) and xarModAPIfunc('mag','user','testtemplate',array('templateName'=&gt;'archive-issues','templateSuffix'=&gt;$mag_ref))">
                            <xar:template file="archive-issues-$mag_ref" module="mag" subdata="#array('mag'=&gt;$mag,'issues'=&gt;$issues,'issueids'=&gt;$loop:months:item)#" />
                        <xar:else />
                            <xar:template file="archive-issues" module="mag" subdata="#array('mag'=&gt;$mag,'issues'=&gt;$issues,'issueids'=&gt;$loop:months:item)#" />
                        </xar:if>
                        
                    </xar:loop>

                </xar:loop>
                <div style="clear: both;"></div>
                <xar:if condition="!empty($pager)"><div class="mag-pager">#$pager#</div></xar:if>
            </div>
        </xar:if>
    </xar:if>

</div>
