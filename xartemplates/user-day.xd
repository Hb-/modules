<xar:template file="navheader" />
<xar:style scope="module" module="calendar" file="user-month" />
<xar:style scope="module" module="calendar" file="default" />
<!--
<xar:comment>
    Define our navigation elements.
    TODO: Make a nice API Function for creating the valid URLS
    <xar:set name="prevYearURL">#xarModURL('calendar','user','day',array('cal_sdow'=>$cal_sdow,'cal_date'=>$prevYear))#</xar:set>

</xar:comment>
-->
<xar:calendar-decorator object="$Day" decorator="Xaraya" name="$DayURI" />

<xar:set name="prevYearTitle"><xar:mlstring>Previous Year</xar:mlstring></xar:set>
<xar:set name="prevYearURL">#$DayURI->prev('year')#</xar:set>

<xar:set name="prevDayTitle"><xar:mlstring>Previous Day</xar:mlstring></xar:set>
<xar:set name="prevDayURL">#$DayURI->prev('day')#</xar:set>

<xar:set name="nextDayTitle"><xar:mlstring>Next Day</xar:mlstring></xar:set>
<xar:set name="nextDayURL">#$DayURI->next('day')#</xar:set>

<xar:set name="nextYearTitle"><xar:mlstring>Next Year</xar:mlstring></xar:set>
<xar:set name="nextYearURL">#$DayURI->next('year')#</xar:set>

<table id="cal-calendar">
    <tr>
        <th colspan="3" class="cal-navigation">
            <a href="#$prevYearURL#" title="#$prevYearTitle#">&lt;&lt;</a>
            <a href="#$prevDayURL#" title="#$prevDayTitle#">&lt;</a>
            #xarLocaleFormatDate('%B %d %Y',$Day->getTimeStamp())#
            <a href="#$nextDayURL#" title="#$nextDayTitle#">&gt;</a>
            <a href="#$nextYearURL#" title="#$nextYearTitle#">&gt;&gt;</a>
        </th>
    </tr>

    <div style="position: relative" >
    <xar:set name="Hour">$Day->fetch()</xar:set>
    <xar:while condition="$Hour">
        <xar:set name="start">xarModGetVar('calendar','day_start')/100</xar:set>
        <xar:set name="end">xarModGetVar('calendar','day_end')/100</xar:set>
        <xar:if condition="($Hour:thisHour() ge $start) and ($Hour:thisHour() le $end)" >
<!--            <tr>
                <td rowspan="4" align="center" valign="top" width="10%" class="timeborder">
                #$Hour:thisHour()#:#$Hour:thisMinute()#
                </td>
                <td class="dayborder">
                    <xar:if condition="$Hour:isSelected()">
                        <div style="position: relatve;" >#$Hour:getEntry()#<div>
                    <xar:else />
                        &#160;
                    </xar:if>
                </td>
            </tr>
            <tr>
                <td class="dayborder2">&#160;</td>
            </tr>
            <tr>
                <td class="dayborder">&#160;</td>
            </tr>
            <tr>
                <td class="dayborder2">&#160;</td>
            </tr>-->
        </xar:if>
        <xar:set name="Hour">$Day->fetch()</xar:set>
    </xar:while>
    </div>
</table>

    <div style="border: 1px solid #A1A5A9;" >
    <xar:set name="slots">array(0)</xar:set>
    <xar:set name="Hour">$Day->fetch()</xar:set>
    <xar:while condition="$Hour">
        <xar:set name="start">xarModGetVar('calendar','day_start')/100</xar:set>
        <xar:set name="end">xarModGetVar('calendar','day_end')/100</xar:set>
        <xar:if condition="($Hour:thisHour() ge $start) and ($Hour:thisHour() le $end)" >
            <div style="border-bottom: 1px solid #A1A5A9;" >
                <div style="width: 10%; float: left; text-align: center">
                        #$Hour:thisHour()#:#$Hour:thisMinute()#
                </div>
                <div style="position: relative; width: 90%; float: left; ">
                    <div style="height:10px; border-top: 1px dashed #ccc; border-left: 2px solid #A1A5A9; border-top: 1px solid #A1A5A9;">
                    </div>
                    <div style="height:10px; border-top: 1px dashed #ccc; border-left: 2px solid #A1A5A9;">
                    </div>
                    <div style="height:10px; border-top: 1px dashed #ccc; border-left: 2px solid #A1A5A9;">
                    </div>
                    <div style="height:10px; border-top: 1px dashed #ccc; border-left: 2px solid #A1A5A9;">
                    </div>
                    <xar:if condition="$Hour:isSelected()">
                        <xar:set name="entries">$Hour->getEntries()</xar:set>
                        <xar:foreach in="$entries" value="$entry">
                            <xar:set name="placed">false</xar:set>
                            <xar:set name="limit">count($slots)</xar:set>
                            <xar:for start="$i = 0" test="$i lt $limit" iter="$i++">
                                <xar:if condition="$entry.start ge $slots.$i" >
                                    <xar:set name="thisslot">$i</xar:set>
                                    <xar:set name="dummy">1;$slots[$i] = $entry['end']</xar:set>
                                    <xar:set name="placed">true</xar:set>
                                    <xar:break />
                                </xar:if>
                            </xar:for>
                            <xar:if condition="!$placed" >
                                <xar:set name="thisslot">$limit</xar:set>
                                <xar:set name="dummy">1;$slots[] = $entry['end']</xar:set>
                            </xar:if>
                            <xar:set name="offset">$thisslot*30</xar:set>
                            <xar:set name="offset1">$thisslot*40</xar:set>
                            <div style="z-index: 3000; padding: 1px; color: white; position: absolute; top: 1px; left: #$offset#%; width: 30%; height: 100px; background-color: red" >
                                <img src="#xarTplGetImage('recurring.gif')#" />
                                &#160;
                                #$entry.desc# #$offset#
                            </div>
                        </xar:foreach>
                    </xar:if>
                </div>
            </div>
            <div style="clear: both" ></div>
        </xar:if>
        <xar:set name="Hour">$Day->fetch()</xar:set>
    </xar:while>
    </div>

<xar:comment> include the calendar footer </xar:comment>
<xar:template file="todayfooter" />
</div>
