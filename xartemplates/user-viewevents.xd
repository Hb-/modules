<xar:comment>License: GPL http://www.gnu.org/copyleft/gpl.html </xar:comment>
<div class="xar-julian xar-julian-user-viewevents">

    <xar:template file="header" />

    <div class="xar-julian-contents">
        <h2><xar:mlstring>List of Events</xar:mlstring></h2>

        <xar:comment>This selection allows the user to choose a specific date range. Comment out if not required.</xar:comment>

        <div>
          <form name="date_range" method="post" action="#xarModURL('julian','user','viewevents')#" onsubmit="return validate(this)">
            <div>
              <xar:comment>
                If not using short URLs, then use hidden values for form submission.
                This is to fix a problem in the way browsers handle GET parameters.
              </xar:comment>
              <xar:if condition="!xarModGetVar('julian', 'SupportShortURLs')">
                <input type="hidden" name="module" value="julian" />
                <input type="hidden" name="type" value="user" />
                <input type="hidden" name="func" value="viewevents" />
              </xar:if>

              <label><xar:mlstring>Show events from:</xar:mlstring></label>

              <select name="start_day" style="width: 3em;">
                <option value=""></option>
                <xar:for start="$i = 1" test="$i le 31" iter="$i++">
                  <xar:if condition="$i lt 10">
                    <xar:set name="$currDay">str_pad($i,2,'0',STR_PAD_LEFT)</xar:set>
                  <xar:else />
                    <xar:set name="$currDay">#$i#</xar:set>
                  </xar:if>
                  <xar:set name="$daySelected">""</xar:set>
                  <xar:if condition="$start_day eq $currDay">
                    <option value="#$currDay#" selected="selected">#$currDay#</option>
                  <xar:else />
                    <option value="#$currDay#">#$currDay#</option>
                  </xar:if>
                </xar:for>
              </select>

              <select name="start_month" onchange="populateSelect(this, this.form.start_day, this.form.start_year)" style="width: 7.5em;">
                <option value=""></option>
                <xar:for start="$i = 1" test="$i le 12" iter="$i++">
                  <xar:if condition="$i lt 10">
                    <xar:set name="$currMonth">str_pad($i,2,'0',STR_PAD_LEFT)</xar:set>
                  <xar:else />
                    <xar:set name="$currMonth">#$i#</xar:set>
                  </xar:if>
                  <xar:set name="$currMonth_long">date("F",mktime(0,0,0,$currMonth,1,2005))</xar:set>
                  <xar:set name="$monthSelected">""</xar:set>
                  <xar:if condition="$start_month eq $currMonth">
                    <option value="#$currMonth#" selected="selected">#$currMonth_long#</option>
                  <xar:else />
                    <option value="#$currMonth#">#$currMonth_long#</option>
                  </xar:if>
                </xar:for>
              </select>

              <select name="start_year" onchange="populateSelect(this.form.start_month, this.form.start_day, this)"style="width: 4.2em;">
                <option value=""></option>
                <xar:for start="$i = date('Y')+10" test="$i ge date('Y')-10" iter="$i--">
                  <xar:set name="$yearSelected">""</xar:set>
                  <xar:if condition="$start_year eq $i">
                    <option value="#$i#" selected="selected">#$i#</option>
                  <xar:else />
                    <option value="#$i#">#$i#</option>
                  </xar:if>
                </xar:for>
              </select>

              <label><xar:mlstring>to</xar:mlstring></label>

              <select name="end_day" style="width: 3em;">
                <option value=""></option>
                <xar:for start="$i = 1" test="$i le 31" iter="$i++">
                  <xar:if condition="$i lt 10">
                    <xar:set name="$currEndDay">str_pad($i,2,'0',STR_PAD_LEFT)</xar:set>
                  <xar:else />
                    <xar:set name="$currEndDay">#$i#</xar:set>
                  </xar:if>
                  <xar:set name="$dayEndSelected">""</xar:set>
                  <xar:if condition="$end_day eq $currEndDay">
                    <option value="#$currEndDay#" selected="selected">#$currEndDay#</option>
                  <xar:else />
                    <option value="#$currEndDay#">#$currEndDay#</option>
                  </xar:if>
                </xar:for>
              </select>

              <select name="end_month" onchange="populateSelect(this, this.form.end_day, this.form.end_year)" style="width: 7.5em;" >
                <option value=""></option>
                <xar:for start="$i = 1" test="$i le 12" iter="$i++">
                  <xar:if condition="$i lt 10">
                    <xar:set name="$currEndMonth">str_pad($i,2,'0',STR_PAD_LEFT)</xar:set>
                  <xar:else />
                    <xar:set name="$currEndMonth">#$i#</xar:set>
                  </xar:if>
                  <xar:set name="$currEndMonth_long">date("F",mktime(0,0,0,$currEndMonth,1,2005))</xar:set>
                  <xar:set name="$monthEndSelected">""</xar:set>
                  <xar:if condition="$end_month eq $currEndMonth">
                    <option value="#$currEndMonth#" selected="selected">#$currEndMonth_long#</option>
                  <xar:else />
                    <option value="#$currEndMonth#">#$currEndMonth_long#</option>
                  </xar:if>
                </xar:for>
              </select>

              <select name="end_year" onchange="populateSelect(this.form.end_month, this.form.end_day, this)" style="width: 4.2em;">
                <option value=""></option>
                <xar:for start="$i = date('Y')+10" test="$i ge date('Y')-10" iter="$i--">
                  <xar:set name="$yearEndSelected">""</xar:set>
                  <xar:if condition="$end_year eq $i">
                    <option value="#$i#" selected="selected">#$i#</option>
                  <xar:else />
                    <option value="#$i#">#$i#</option>
                  </xar:if>
                </xar:for>
              </select>

              <input type="hidden" name="group" value="#$group#" />
            
              <input type="submit" name="submit" value="#xarML('Set Date Range')#" />
            </div>
          </form>
        </div>

        <xar:comment>This selection allows the user to choose the next N days/weeks/months/years. Comment out if not required.</xar:comment>

        <div>
            <form method="get" action="#xarModURL('julian','user','viewevents')#">
                <div>
                    <xar:if condition="!xarModGetVar('julian', 'SupportShortURLs')">
                        <input type="hidden" name="module" value="julian" />
                        <input type="hidden" name="type" value="user" />
                        <input type="hidden" name="func" value="viewevents" />
                    </xar:if>

                    <label for="datenumber"><xar:mlstring>Events for the next:</xar:mlstring></label>
                    <input type="text" name="datenumber" id="datenumber" value="#$datenumber#" style="width: 3em;" />

                    <xar:set name="datetypelist">array('days'=>xarML('Day(s)'), 'weeks'=>xarML('Week(s)'), 'months'=>xarML('Month(s)'), 'year'=>xarML('Year(s)'))</xar:set>
                    <xar:data-input name="datetype" id="datetype" type="6" validation="$datetypelist" value="$datetype" />

                    <input type="hidden" name="group" value="#$group#" />
                    <input type="submit" name="submit" value="Get Events" />
                </div>
            </form>
        </div>

        <xar:comment> Add the category browser to play with</xar:comment>
        <xar:if condition="xarModIsHooked('categories','julian')">
            <xar:categories-navigation layout="trails" showchildren="1" module="julian" catid="$catid" func="viewevents" sortby="$sortby" />
        </xar:if>

        <xar:comment>TODO: there must be a way to get these tabs into a DD property or widget?
        Or at least some easy way to map the if-then-else condition onto a range of classes.
        It just seems so clumsy and wasteful, where-ever tabs are used.</xar:comment>
        <dl class="xar-tabs">
            <dt class="help"><xar:mlstring>Group by:</xar:mlstring></dt>
            <xar:if condition="empty($group)"><xar:set name="active">'active'</xar:set><xar:else/><xar:set name="active">''</xar:set></xar:if>
            <dd class="#$active#"><a href="#xarServerGetCurrentURL(array_merge($urlparams,array('group'=&gt;null)))#"><xar:mlstring>None</xar:mlstring></a></dd>
            <xar:if condition="$group eq 'day'"><xar:set name="active">'active'</xar:set><xar:else/><xar:set name="active">''</xar:set></xar:if>
            <dd class="#$active#"><a href="#xarServerGetCurrentURL(array_merge($urlparams,array('group'=&gt;'day')))#"><xar:mlstring>Day</xar:mlstring></a></dd>
            <xar:if condition="$group eq 'week'"><xar:set name="active">'active'</xar:set><xar:else/><xar:set name="active">''</xar:set></xar:if>
            <dd class="#$active#"><a href="#xarServerGetCurrentURL(array_merge($urlparams,array('group'=&gt;'week')))#"><xar:mlstring>Week</xar:mlstring></a></dd>
            <xar:if condition="$group eq 'month'"><xar:set name="active">'active'</xar:set><xar:else/><xar:set name="active">''</xar:set></xar:if>
            <dd class="#$active#"><a href="#xarServerGetCurrentURL(array_merge($urlparams,array('group'=&gt;'month')))#"><xar:mlstring>Month</xar:mlstring></a></dd>
            <xar:if condition="$group eq 'year'"><xar:set name="active">'active'</xar:set><xar:else/><xar:set name="active">''</xar:set></xar:if>
            <dd class="#$active#"><a href="#xarServerGetCurrentURL(array_merge($urlparams,array('group'=&gt;'year')))#"><xar:mlstring>Year</xar:mlstring></a></dd>
        </dl>

        <xar:if condition="!isset($groups)">
            <xar:comment>The original format, with no grouping</xar:comment>
            <xar:template file="view-events-tabular" />
        <xar:else/>
            <xar:comment>List grouping form - allow user to decide the grouping.
            Replaced by a set of tabs now, but the code here in case it is useful.</xar:comment>
            <xar:comment>
            <div>
                <form method="get" action="#xarModURL('julian','user','viewevents')#">
                    <div>
                        <xar:if condition="!xarModGetVar('julian', 'SupportShortURLs')">
                            <input type="hidden" name="module" value="julian" />
                            <input type="hidden" name="type" value="user" />
                            <input type="hidden" name="func" value="viewevents" />
                        </xar:if>

                        <label for="group"><xar:mlstring>Group by:</xar:mlstring> </label>
                        <xar:set name="grouplist">array('day'=>xarML('Day'), 'week'=>xarML('Week'), 'month'=>xarML('Month'), 'year'=>xarML('Year'))</xar:set>
                        <xar:data-input name="group" id="group" type="6" validation="$grouplist" value="$group" />

                        <input type="hidden" name="startdate" value="#$startdate#" />
                        <input type="hidden" name="enddate" value="#$enddate#" />

                        <input type="submit" name="submit" value="Submit"/>
                    </div>
                </form>
            </div>
            </xar:comment>

            <div class="xar-julian-grouped-list">
                <xar:comment>TODO: Each grouping section to be split into a separate template</xar:comment>

                <xar:if condition="$group eq 'week'">
                    <xar:loop name="$groups">
                        <h2>
                            <xar:ml>
                                <xar:mlstring>Week #(1): #(2) to #(3)</xar:mlstring>
                                <xar:mlvar>#$loop:key#</xar:mlvar>
                                <xar:mlvar>#xarLocaleGetFormattedDate('long',$loop:item.periodstart)#</xar:mlvar>
                                <xar:mlvar>#xarLocaleGetFormattedDate('long',$loop:item.periodend)#</xar:mlvar>
                            </xar:ml>
                        </h2>

                        <table class="xar-julian-grouped-week">
                            <thead>
                                <tr>
                                    <th class="date"><xar:mlstring>Date</xar:mlstring></th>
                                    <th class="time"><xar:mlstring>Time</xar:mlstring></th>
                                    <th class="name"><xar:mlstring>Name</xar:mlstring></th>
                                </tr>
                            </thead>
                            <xar:loop name="$loop:item.events">
                                <xar:set name="event">#$events[$loop:item]#</xar:set>
                                <tr>
                                    <td class="date">#$events[$loop:item].eStart.viewdate#</td>
                                    <td class="time">
                                        <xar:template file="event-time" subdata="array('event'=&gt;$event)" />
                                    </td>
                                    <td class="name">
                                        <a href="#xarModURL('julian','user','viewevent',array('cal_date'=>$event.eStart.linkdate,'event_id'=>$event.eID))#">
                                        #xarVarPrepForDisplay($event.eName)#
                                        </a>
                                    </td>
                                </tr>
                            </xar:loop>
                        </table>
                    </xar:loop>
                </xar:if>

                <xar:if condition="$group eq 'day'">
                    <xar:loop name="$groups">
                        <h2>
                            <xar:ml>
                                <xar:mlstring>#(1)</xar:mlstring>
                                <xar:mlvar>#xarLocaleGetFormattedDate('long', $loop:item.periodstart)#</xar:mlvar>
                            </xar:ml>
                        </h2>
                        <table class="xar-julian-grouped-day">
                            <xar:loop name="$loop:item.events">
                                <xar:set name="event">#$events[$loop:item]#</xar:set>
                                <tr>
                                    <td class="date"><xar:template file="event-time" subdata="array('event'=&gt;$event)" /></td>
                                    <td class="name"><a href="#xarModURL('julian','user','viewevent',array('cal_date'=>$event.eStart.linkdate,'event_id'=>$event.eID))#">
                                        #xarVarPrepForDisplay($event.eName)#
                                    </a></td>
                                </tr>
                            </xar:loop>
                        </table>
                    </xar:loop>
                </xar:if>

                <xar:if condition="$group eq 'month'">
                    <xar:loop name="$groups">
                        <h2>
                            <xar:ml>
                                <xar:mlstring>#(1) #(2)</xar:mlstring>
                                <xar:mlvar>#xarLocaleFormatDate('%B', ($loop:item.periodstart))#</xar:mlvar>
                                <xar:mlvar>#xarLocaleFormatDate('%Y', ($loop:item.periodstart))#</xar:mlvar>
                            </xar:ml>
                        </h2>
                        <table class="xar-julian-grouped-month">
                            <xar:loop name="$loop:item.events">
                                <xar:set name="event">#$events[$loop:item]#</xar:set>
                                <tr>
                                    <td class="date">#$events[$loop:item].eStart.viewdate#</td>
                                    <td class="time">
                                        <xar:template file="event-time" subdata="array('event'=&gt;$event)" />
                                    </td>

                                    <td class="name"><a href="#xarModURL('julian','user','viewevent',array('cal_date'=>$event.eStart.linkdate,'event_id'=>$event.eID))#">
                                        #xarVarPrepForDisplay($event.eName)#
                                    </a></td>
                                </tr>
                            </xar:loop>
                        </table>
                    </xar:loop>
                </xar:if>

                <xar:if condition="$group eq 'year'">
                    <xar:loop name="$groups">
                        <h2>
                            <xar:ml>
                                <xar:mlstring>Year #(1)</xar:mlstring>
                                <xar:mlvar>#xarLocaleFormatDate('%Y', ($loop:item.periodstart))#</xar:mlvar>
                            </xar:ml>
                        </h2>
                        <table class="xar-julian-grouped-year">
                            <xar:loop name="$loop:item.events">
                                <xar:set name="event">#$events[$loop:item]#</xar:set>
                                <tr>
                                    <td class="date">#$events[$loop:item].eStart.viewdate#</td>
                                    <td class="time">
                                        <xar:template file="event-time" subdata="array('event'=&gt;$event)" />
                                    </td>

                                    <td class="name"><a href="#xarModURL('julian','user','viewevent',array('cal_date'=>$event.eStart.linkdate,'event_id'=>$event.eID))#">
                                        #xarVarPrepForDisplay($event.eName)#
                                    </a></td>
                                </tr>
                            </xar:loop>
                        </table>
                    </xar:loop>
                </xar:if>
            </div>
        </xar:if>
    </div>
    <div>#$pager#</div>
</div>